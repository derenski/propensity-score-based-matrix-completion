WITH allCountyNames AS (SELECT DISTINCT CAST(county_number AS INT64) AS county_number_int,
LOWER(county) AS county, RANK() OVER (PARTITION BY county_number ORDER BY CHAR_LENGTH(county) DESC) AS good_name
FROM `bigquery-public-data.iowa_liquor_sales.sales` 
WHERE county_number IS NOT NULL
ORDER BY county_number_int
),
validCountyNames AS (SELECT * FROM allCountyNames WHERE good_name=1), 
dataWithFixedNames AS (SELECT CAST(county_number AS INT64) AS county_number, cn.county, EXTRACT(YEAR FROM date) AS order_year, EXTRACT(MONTH FROM date) AS order_month, volume_sold_liters AS order_amount, sale_dollars AS order_revenue FROM `bigquery-public-data.iowa_liquor_sales.sales` ls
JOIN validCountyNames cn 
ON cn.county_number_int = CAST(county_number AS INT64))
SELECT county_number, county, order_year, order_month, ROUND(SUM(order_amount), 2) order_amount, ROUND(SUM(order_revenue), 2) order_revenue, COUNT(*) AS number_of_orders FROM dataWithFixedNames 
GROUP BY county_number, county, order_year, order_month
ORDER BY county_number, county, order_year, order_month; 
